<html>
  <head>
    <title>Carena</title>
    <script type="text/javascript" src="../lib/carena.js"></script>
  </head>
  <body>
    <canvas width="600" height="600" id="draggable-window"></canvas>
    <br />
    <span id="fps" style='color:white'></span>
    <script type="text/javascript">
      (function() {
        var canvas   = document.getElementById("draggable-window")
            renderer = carena.build({}, ["carena.Renderer"], {
              canvas: canvas
            }),
            camera = carena.build({}, [
              "carena.Camera",
              "carena.DragManager"
            ], {
              renderer: renderer
            }),
            scene = carena.build({}, ["carena.Node", "carena.Eventable"]),
            mouse    = {x:0, y:0},
            fps      = 1000/60,
            averageFPS = 0
            frame = 1,
            lastTime = 0,
            fpsDisplay = document.getElementById("fps");

        for (var i=0;i<10000; i++) {
          var node = carena.build({
            x: Math.floor((Math.random()*canvas.width)%canvas.width),
            y: Math.floor((Math.random()*canvas.height)%canvas.height),
            width: 1,
            height: 1,
            color: "white",
            update : function(obj) {
              obj.x = obj.x + 10;
            }
          }, ["carena.Node"]);

          scene.add(node);
        }
        document.body.style.backgroundColor = "black";
        renderer.context.fillStyle = "black";
        renderer.context.fillRect(0,0,canvas.width, canvas.height);
        var cw = canvas.width,
            ch = canvas.height,
            imageData = renderer.context.getImageData(0,0,cw,ch),
            child,
            childrenl = scene.children.length,
            loc,
            updateTime = 25, start, dirty = false,
            ctx = renderer.context;

        setTimeout(function update() {
renderer.context.fillRect(0, 0, canvas.width, canvas.height);
imageData = renderer.context.getImageData(0,0,cw,ch);

          for (var i=0; i<childrenl; i++) {
            child = scene.children[i];
            child.x++;
            loc   = (child.x*4) + (cw*child.y*4)
            imageData.data[loc+1] = 255;
            imageData.data[loc+2] = 255;
            imageData.data[loc+3] = 255;
            imageData.data[loc+4] = 255;
          }
          dirty = true;
          setTimeout(update, updateTime);
        }, 10);

        var renderi = 0, children = scene.children, childrenl = children.length;

        setTimeout(function render() {
          renderer.context.putImageData(imageData, 0,0);
          frame++;
          setTimeout(render, fps);
        },fps);


        setInterval(function() {
          fpsDisplay.innerHTML = frame+"fps";
          frame=0;
        }, 1000);

        camera.target = scene;
        lastTime = (new Date()).getTime();
        // so the fps isn't weird initially
 //       camera.render();
/*        setTimeout(function renderDraggableWindow() {
          var l = scene.children.length;
          for (var i=0; i<l; i++) {
            var node = scene.children[i];
            if (node.render) { node.render(renderer); }
          }
          //camera.render();
          frame++;
          setTimeout(renderDraggableWindow, 0);
        }, fps);*/
      }());
    </script>
  </body>
</html>
